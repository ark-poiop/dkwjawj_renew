name: Threads API Test

on:
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      test_type:
        description: 'í…ŒìŠ¤íŠ¸ ìœ í˜•'
        required: true
        default: 'connection'
        type: choice
        options:
          - 'connection'
          - 'post'
          - 'briefing'
  
  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (ë§¤ì¼ ì˜¤ì „ 9ì‹œ KST = UTC 00:00)
  schedule:
    - cron: '0 0 * * *'

jobs:
  threads-api-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Set environment variables
        run: |
          echo "KIS_APP_KEY=${{ secrets.KIS_APP_KEY }}" >> $GITHUB_ENV
          echo "KIS_APP_SECRET=${{ secrets.KIS_APP_SECRET }}" >> $GITHUB_ENV
          echo "THREADS_ACCESS_TOKEN=${{ secrets.THREADS_ACCESS_TOKEN }}" >> $GITHUB_ENV
          echo "THREADS_USER_ID=${{ secrets.THREADS_USER_ID }}" >> $GITHUB_ENV
      
      - name: Test Threads API Connection
        if: github.event.inputs.test_type == 'connection' || github.event_name == 'schedule'
        run: |
          echo "ğŸ§ª Threads API ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          python -c "
          from threads_api_client import ThreadsAPIClient
          client = ThreadsAPIClient()
          print('âœ… Access Token:', 'ìˆìŒ' if client.access_token else 'ì—†ìŒ')
          print('âœ… User ID:', 'ìˆìŒ' if client.user_id else 'ì—†ìŒ')
          print('âœ… Base URL:', client.base_url)
          print('âœ… Post URL:', client.post_url)
          "
      
      - name: Test Threads API Post
        if: github.event.inputs.test_type == 'post'
        run: |
          echo "ğŸ§ª Threads API ê²Œì‹œ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          python -c "
          from threads_api_client import ThreadsAPIClient
          import json
          
          client = ThreadsAPIClient()
          test_content = 'ğŸ§ª GitHub Actionsì—ì„œ Threads API í…ŒìŠ¤íŠ¸\n\nì´ê²ƒì€ ìë™í™”ëœ í…ŒìŠ¤íŠ¸ ê²Œì‹œë¬¼ì…ë‹ˆë‹¤.\n\n#ThreadsAPI #GitHubActions #í…ŒìŠ¤íŠ¸'
          
          try:
              result = client.post_thread(test_content)
              print('âœ… ê²Œì‹œ ì„±ê³µ!')
              print('ğŸ“ ê²°ê³¼:', json.dumps(result, indent=2, ensure_ascii=False))
          except Exception as e:
              print('âŒ ê²Œì‹œ ì‹¤íŒ¨:', str(e))
              exit(1)
          "
      
      - name: Test Threads API Briefing
        if: github.event.inputs.test_type == 'briefing'
        run: |
          echo "ğŸ§ª Threads API ë¸Œë¦¬í•‘ í…ŒìŠ¤íŠ¸ ì‹œì‘..."
          python -c "
          from threads_api_client import ThreadsAPIClient
          import json
          
          client = ThreadsAPIClient()
                    test_briefing = 'ğŸŒ… ì‹œì¥ ë¸Œë¦¬í•‘ í…ŒìŠ¤íŠ¸\n\nâ€¢ S&P500 5,500.12pt (+0.8%)\nâ€¢ ë‚˜ìŠ¤ë‹¥ 17,900.45pt (+1.1%)\nâ€¢ ë‹¤ìš° 38,500pt (+0.3%)\n\nğŸ’¡ í…ŒìŠ¤íŠ¸ ê´€ì „í¬ì¸íŠ¸\n- GitHub Actions ìë™í™” í…ŒìŠ¤íŠ¸\n- Threads API ì—°ë™ í™•ì¸\n\n#ì‹œì¥ë¸Œë¦¬í•‘ #í…ŒìŠ¤íŠ¸ #ThreadsAPI'
          
          try:
              result = client.post_briefing(test_briefing, '07:00')
              print('âœ… ë¸Œë¦¬í•‘ ê²Œì‹œ ì„±ê³µ!')
              print('ğŸ“ ê²°ê³¼:', json.dumps(result, indent=2, ensure_ascii=False))
          except Exception as e:
              print('âŒ ë¸Œë¦¬í•‘ ê²Œì‹œ ì‹¤íŒ¨:', str(e))
              exit(1)
          "
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: threads-api-test-results
          path: |
            briefing_system.log
          retention-days: 3
      
      - name: Notify test results
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#market-briefing'
          text: |
            Threads API í…ŒìŠ¤íŠ¸ ê²°ê³¼:
            - í…ŒìŠ¤íŠ¸ ìœ í˜•: ${{ github.event.inputs.test_type || 'scheduled' }}
            - ìƒíƒœ: ${{ job.status }}
            - ì‹¤í–‰ ì‹œê°„: ${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        continue-on-error: true 